# Orderflow Service

A RESTful HTTP service that provides order management and discovery capabilities, facilitating the creation, retrieval, and management of private OTC orders on the Aztec network.

## üîë Key Features

- **Order Management**: Create, update, and manage private OTC orders with unique escrow addresses
- **Order Discovery**: Query, filter, and search for existing orders by various parameters
- **Private Order Coordination**: Facilitate secure communication between trading parties
- **SQLite Database**: Persistent storage with pluggable architecture for scalability
- **RESTful API**: Standard HTTP endpoints for seamless integration

## üöÄ Quick Start

```bash
bun install
bun run start  # Production mode
bun run dev    # Development mode with hot reload
```

The service will start on `http://localhost:3000`.

## Endpoints

### POST /order
Create a new order. The `orderId` is automatically generated by the server.

**Important**: Each `escrowAddress` can only be used once. Attempting to create an order with an existing escrow address will return a 409 Conflict error.

**Request Body:**
```json
{
  "escrowAddress": "0x1234...",
  "sellTokenAddress": "0x5678...",
  "sellTokenAmount": "1000000000000000000",
  "buyTokenAddress": "0x9abc...",
  "buyTokenAmount": "2000000000000000000"
}
```

**Note**: BigInt values (`sellTokenAmount`, `buyTokenAmount`) should be sent as strings in JSON and will be returned as strings in responses.

**Request:**
```bash
curl -X POST http://localhost:3000/order \
  -H "Content-Type: application/json" \
  -d '{
    "escrowAddress": "0x1234567890abcdef1234567890abcdef12345678",
    "sellTokenAddress": "0x5678901234abcdef5678901234abcdef56789012",
    "sellTokenAmount": "1000000000000000000",
    "buyTokenAddress": "0x9abcdef123456789abcdef123456789abcdef12",
    "buyTokenAmount": "2000000000000000000"
  }'
```

**Response:**
```json
{
  "success": true,
  "message": "Order created successfully",
  "data": {
    "orderId": "generated-uuid-here",
    "escrowAddress": "0x1234567890abcdef1234567890abcdef12345678",
    "sellTokenAddress": "0x5678901234abcdef5678901234abcdef56789012",
    "sellTokenAmount": "1000000000000000000",
    "buyTokenAddress": "0x9abcdef123456789abcdef123456789abcdef12",
    "buyTokenAmount": "2000000000000000000"
  }
}
```

**Error Response (409 Conflict):**
```json
{
  "success": false,
  "error": "Order with escrow address 0x1234567890abcdef1234567890abcdef12345678 already exists"
}
```

### GET /order
Retrieve order(s). Always returns an array for consistent interface. Supports filtering by various parameters.

**Query Parameters:**
- `id` - Get specific order by order ID
- `escrow_address` - Filter by escrow address
- `sell_token_address` - Filter by sell token address  
- `buy_token_address` - Filter by buy token address

Parameters can be combined for more specific filtering.

**Get All Orders:**
```bash
curl http://localhost:3000/order
```

**Response (All Orders):**
```json
{
  "success": true,
  "message": "Retrieved 2 order(s)",
  "data": [
    {
      "orderId": "uuid-1",
      "escrowAddress": "0x1234567890abcdef1234567890abcdef12345678",
      "sellTokenAddress": "0x5678901234abcdef5678901234abcdef56789012",
      "sellTokenAmount": "1000000000000000000",
      "buyTokenAddress": "0x9abcdef123456789abcdef123456789abcdef12",
      "buyTokenAmount": "2000000000000000000"
    },
    {
      "orderId": "uuid-2",
      "escrowAddress": "0xabcdef1234567890abcdef1234567890abcdef12",
      "sellTokenAddress": "0xfedcba0987654321fedcba0987654321fedcba09",
      "sellTokenAmount": "5000000000000000000",
      "buyTokenAddress": "0x1111222233334444555566667777888899990000",
      "buyTokenAmount": "3000000000000000000"
    }
  ]
}
```

**Get Specific Order:**
```bash
curl http://localhost:3000/order?id=uuid-1
```

**Response (Single Order in Array):**
```json
{
  "success": true,
  "message": "Order retrieved successfully",
  "data": [
    {
      "orderId": "uuid-1",
      "escrowAddress": "0x1234567890abcdef1234567890abcdef12345678",
      "sellTokenAddress": "0x5678901234abcdef5678901234abcdef56789012",
      "sellTokenAmount": "1000000000000000000",
      "buyTokenAddress": "0x9abcdef123456789abcdef123456789abcdef12",
      "buyTokenAmount": "2000000000000000000"
    }
  ]
}
```

**Filter by Escrow Address:**
```bash
curl "http://localhost:3000/order?escrow_address=0x1234567890abcdef1234567890abcdef12345678"
```

**Filter by Sell Token:**
```bash
curl "http://localhost:3000/order?sell_token_address=0x5678901234abcdef5678901234abcdef56789012"
```

**Filter by Buy Token:**
```bash
curl "http://localhost:3000/order?buy_token_address=0x9abcdef123456789abcdef123456789abcdef12"
```

**Combined Filters:**
```bash
curl "http://localhost:3000/order?sell_token_address=0x5678901234abcdef5678901234abcdef56789012&buy_token_address=0x9abcdef123456789abcdef123456789abcdef12"
```

**Filtered Response Example:**
```json
{
  "success": true,
  "message": "Retrieved 1 order(s) filtered by sell token: 0x5678901234abcdef5678901234abcdef56789012",
  "data": [
    {
      "orderId": "uuid-1",
      "escrowAddress": "0x1234567890abcdef1234567890abcdef12345678",
      "sellTokenAddress": "0x5678901234abcdef5678901234abcdef56789012",
      "sellTokenAmount": "1000000000000000000",
      "buyTokenAddress": "0x9abcdef123456789abcdef123456789abcdef12",
      "buyTokenAmount": "2000000000000000000"
    }
  ]
}
```

**Error Response (Order Not Found):**
```json
{
  "success": false,
  "error": "Order with ID uuid-nonexistent not found",
  "data": []
}
```

## Development

### Install Dependencies
```bash
bun install
```

### Run in Development Mode
```bash
bun run dev
```

### Run in Production Mode
```bash
bun run start
```

### Build
```bash
bun run build
```

### Testing
```bash
# Run all tests
bun test

# Run specific test suites
bun run test:db           # Database tests only
bun run test:handlers     # Handler tests only
bun run test:integration  # Integration tests only

# Watch mode for development
bun run test:watch
```

**Test Coverage:**
- ‚úÖ **Database Tests**: Order creation, deduplication, retrieval, and filtering
- ‚úÖ **Handler Tests**: POST/GET endpoints with various scenarios
- ‚úÖ **Integration Tests**: Comprehensive filtering and edge cases
- ‚úÖ **Error Handling**: Invalid inputs, duplicate constraints, server errors

## üóÑÔ∏è Database

The service uses a **pluggable database architecture** with a clean interface that supports multiple database backends.

### Current Implementation
- **Default**: SQLite using Bun's built-in SQLite support
- **Database file**: `orders.sqlite` (created automatically in project root)
- **Schema**: Optimized for fast order queries and filtering

### Database Schema
```sql
CREATE TABLE orders (
  orderId TEXT PRIMARY KEY,
  escrowAddress TEXT NOT NULL UNIQUE,
  sellTokenAddress TEXT NOT NULL,
  sellTokenAmount TEXT NOT NULL,
  buyTokenAddress TEXT NOT NULL,
  buyTokenAmount TEXT NOT NULL,
  createdAt DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## ‚úÖ Implementation Status

- ‚úÖ **Order Creation**: Fully implemented with SQLite persistence and unique escrow address constraint
- ‚úÖ **Order Retrieval**: Complete support for retrieving all orders or filtering by various parameters
- ‚úÖ **Query Filtering**: Advanced filtering by escrow address, sell token, and buy token addresses
- ‚úÖ **Database Architecture**: Pluggable interface ready for multiple database backends
- ‚úÖ **Comprehensive Testing**: Full test coverage including database, handlers, and integration tests

## üõ†Ô∏è Technology Stack

- **Runtime**: Bun with native HTTP server
- **Database**: SQLite (pluggable architecture for PostgreSQL, MongoDB, etc.)
- **Testing**: Jest with Bun test runner
- **TypeScript**: Full type safety across all components

## üîó Integration

This service is designed to work seamlessly with:
- **Contracts Package**: Receives escrow addresses from deployed contracts
- **CLI Demo**: Provides order discovery and management for the demonstration workflow
- **External Applications**: RESTful API for third-party integrations
